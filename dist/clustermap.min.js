!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ClusterMap={})}(this,(function(t){"use strict";function e(){let t=d3.select(this),e=prompt("Enter new value:",t.text());e&&t.text(e)}function n(t,e){for(const[r,l]of Object.entries(e))t.hasOwnProperty(r)&&((a=l)&&a.constructor===Object?n(t[r],l):t[r]=l);var a}function a(){const t={transitionDuration:500,scaleFactor:15,spacing:50,offsetFromZero:!1,trackBar:{colour:"#111",stroke:1},gene:{shape:{bodyHeight:12,tipHeight:5,tipLength:12,onClick:null},label:{anchor:"start",fontSize:10,rotation:12,show:!0,start:.5}}},e={x:d3.scaleLinear().domain([0,1e3]).range([0,t.scaleFactor]),offset:null,locus:null,group:null,colour:null};let a=null,r=()=>{a&&a.call(s)},l=!1,o=d3.transition().duration(t.transitionDuration);function s(s){t&&s.each((function(s){e.locus||(e.locus=d3.scaleOrdinal().domain(s.loci.map(t=>t.uid)).range([1,s.loci.slice(0,s.loci.length).map(t=>t.start)])),a=d3.select(this);let f=a.selectAll("g.locus").data(s.loci,t=>t.uid).join(n=>{(n=n.append("g").attr("id",i).attr("class","locus").each(t=>{t._start=t.start,t._end=t.end,t._cluster=s.uid})).append("line").attr("class","trackBar").style("fill","#111");let a=n.append("g").attr("class","hover").attr("opacity",0);n.append("g").attr("class","genes"),a.append("rect").attr("class","hover").attr("fill","rgba(0, 0, 0, 0.4)");let o=d3.drag().on("start",()=>{l=!0}).on("drag",(r,l,o)=>{let s=r.genes.filter(t=>t.end<=r._end).map(t=>t.start),i=[r.start,...s].map(t=>e.x(t)),h=i[d(i,d3.event.x)];d3.select(o[l]).attr("x",h-8);let f=e.offset.domain().findIndex(t=>t===r._cluster),x=e.offset.range();t.offsetFromZero?x[f]-=h-e.x(r._start):x[f]+=h-e.x(r._start),e.offset.range(x),r._start=u(h),a.select("rect.hover").attr("x",h).attr("width",g),n.selectAll("g.gene").attr("display",t=>t.start>=r._start&&t.end<=r._end+1?"inline":"none"),d3.selectAll("path.geneLink").attr("display",c),d3.select("#cinfo_"+r._cluster).attr("transform",`translate(${e.locus(r.uid)+e.x(r._start)-10}, 0)`),n.call(p)}).on("end",()=>{l=!1,a.transition().attr("opacity",0),r()});a.append("rect").attr("class","leftHandle").attr("x",-8).call(o);let f=d3.drag().on("start",()=>{l=!0}).on("drag",(t,r,l)=>{let o=t.genes.filter(e=>e.start>=t._start).map(t=>t.end).map(t=>e.x(t)),s=d(o,d3.event.x);t._end=u(o[s]),d3.select(l[r]).attr("x",e.x(t._end)),a.select("rect.hover").attr("width",g),n.selectAll("g.gene").attr("display",e=>e.start>=t._start&&e.end<=t._end+1?"inline":"none"),d3.selectAll("path.geneLink").attr("display",c),n.call(p)}).on("end",()=>{l=!1,a.transition().attr("opacity",0),r()});return a.append("rect").attr("class","rightHandle").call(f),a.selectAll("rect.leftHandle, rect.rightHandle").attr("width",8).attr("cursor","pointer"),n.on("mouseenter",()=>{l||a.transition().attr("opacity",1)}).on("mouseleave",()=>{l||a.transition().attr("opacity",0)}),n.call(h)},t=>t.call(t=>t.transition(o).call(h))),x=function(){let t={scaleFactor:15,transitionDuration:500,shape:{bodyHeight:12,tipHeight:5,tipLength:12,stroke:"black",strokeWidth:1,onClick:null},label:{anchor:"start",fontSize:10,rotation:12,show:!0,start:.5}},e=d3.transition().duration(t.transitionDuration),a={x:d3.scaleLinear().domain([0,1e3]).range([0,t.scaleFactor]),colour:null,group:null},r=()=>{};function l(n){n.each((function(n){d3.select(this).selectAll("g.gene").data(n.genes,t=>t.uid).join(e=>((e=e.append("g").attr("id",c).attr("class","gene").each(t=>{t._locus=n.uid,t._cluster=n._cluster})).append("polygon").attr("class","genePolygon").on("click",t.shape.onClick),e.append("text").text(t=>t.name).attr("class","geneLabel").attr("dy","-0.3em"),e.call(o)),t=>t.call(t=>t.transition(e).call(o)))}))}function o(e){e.selectAll("polygon.genePolygon").attr("class",t=>"genePolygon group-"+t.group).attr("points",u).attr("fill",s).style("stroke",t.shape.stroke).style("stroke-width",t.shape.strokeWidth),e.selectAll("text.geneLabel").attr("display",t.label.show?"inherit":"none").attr("transform",i).attr("font-size",t.label.fontSize).attr("text-anchor",t.label.Anchor)}function s(t){if(!a.colour||!a.group)return"#bbb";let e=a.group(t.uid);return a.colour(e)}function i(e){let n=a.x(e.end-e.start)*t.label.start;return`translate(${a.x(e.start)+n}, 0) rotate(${["start","middle"].includes(t.label.anchor)?-t.label.rotation:t.label.rotation})`}function c(t){return"gene_"+t.uid}function u(e){let n=[],r=a.x(e.start),l=a.x(e.end),o=l-r,s=2*t.shape.tipHeight+t.shape.bodyHeight,i=s/2,c=t.shape.tipHeight+t.shape.bodyHeight;if(1===e.strand||-1===e.strand&!1){let e=l-t.shape.tipLength;n=[r,t.shape.tipHeight,e,t.shape.tipHeight,e,0,l,i,e,s,e,c,r,c],o<t.shape.tipLength&&[2,4,8,10].forEach(t=>n[t]=r)}else if(-1===e.strand|1===e.strand&!1){let e=r+t.shape.tipLength;n=[l,t.shape.tipHeight,e,t.shape.tipHeight,e,0,r,i,e,s,e,c,l,c],o<t.shape.tipLength&&[2,4,8,10].forEach(t=>n[t]=l)}return n.join(" ")}return l.config=function(e){return arguments.length?(n(t,e),l):t},l.scales=function(t){return arguments.length?(n(a,t),l):a},l.transition=function(t){return arguments.length?(e=t,l):e},l.update=function(t){return arguments.length?(r=t,l):r},l}().config({shape:t.gene.shape,label:t.gene.label}).scales(e).update(r).transition(o);f.selectAll("g.genes").call(x)}))}function i(t){return"locus_"+t.uid}function c(t){let e=d3.select("#gene_"+t.query.uid).attr("display"),n=d3.select("#gene_"+t.target.uid).attr("display");return"none"===e||"none"===n?"none":"inline"}function u(e){return Math.round(1e3*e/t.scaleFactor)}function d(t,e){return Math.max(Math.min(d3.bisectLeft(t,e),t.length-1),0)}function g(t){return e.x(t._end)-e.x(t._start)}function p(n){let a=t.gene.shape.tipHeight+t.gene.shape.bodyHeight/2;n.select("line.trackBar").attr("x1",t=>e.x(t._start)).attr("x2",t=>e.x(t._end)).attr("y1",a).attr("y2",a).style("stroke",t.trackBar.colour).style("stroke-width",t.trackBar.stroke)}function h(n){let a=2*t.gene.shape.tipHeight+t.gene.shape.bodyHeight;n.call(p),n.attr("transform",t=>`translate(${e.locus(t.uid)}, 0)`),n.selectAll("rect.hover, rect.leftHandle, rect.rightHandle").attr("y",-10).attr("height",a+20),n.select("rect.hover").attr("width",g),n.select("rect.rightHandle").attr("x",t=>e.x(t._end))}return s.config=function(e){return arguments.length?(n(t,e),s):t},s.scales=function(t){return arguments.length?(n(e,t),s):e},s.transition=function(t){return arguments.length?(o=t,s):o},s.update=function(t){return arguments.length?(r=t,s):r},s}function r(){const t={transitionDuration:500,scaleFactor:15,nameFontSize:12,lociFontSize:10,spacing:60,locus:{trackBar:{colour:"#111",stroke:1},spacing:50},gene:{shape:{bodyHeight:12,tipHeight:5,tipLength:12},label:{anchor:"start",fontSize:10,rotation:12,show:!0,start:.5}}},e={x:null,y:null,locus:null,offset:null};let a,r=d3.transition(),l=()=>a.call(o);function o(t){t.each((function(t){a=d3.select(this);let e=function(t){return function(e){let n=s(e.query.uid),a=s(e.target.uid);return n=t.clusters.findIndex(t=>t.uid===n._cluster),a=t.clusters.findIndex(t=>t.uid===a._cluster),1===Math.abs(n-a)}}(t);a.selectAll("path.geneLink").data(t.links.filter(e),i).join(t=>t.append("path").attr("class","geneLink").attr("d",c).style("fill","black").style("fill-opacity",t=>t.identity).on("click",(function(){let t=d3.select(this),e=t.style("fill-opacity");for(;;){let n=prompt("Enter new opacity (0-1):",e);if(!n)break;if(n>=0&&n<=1){t.style("fill-opacity",+n);break}alert("Invalid value, try again")}})),t=>t.call(t=>t.transition(r).attr("d",c)))}))}function s(t){return d3.select("#gene_"+t).data()[0]}function i(t){let[e,n]=[t.query.uid,t.target.uid].sort();return`${e}-${n}`}function c(n){let a=s(n.query.uid),r=s(n.target.uid),l=t.gene.shape.tipHeight+t.gene.shape.bodyHeight/2,o=t=>e.offset(t._cluster)+e.locus(t._locus),i=o(a),c=o(r),u=(t,n)=>[e.x(t.start)+n,e.x(t.end)+n,e.y(t._cluster)+l],[d,g,p]=u(a,i),[h,f,x]=u(r,c);return`M${d},${p} L${g},${p} L${f},${x} L${h},${x}`}return o.config=function(e){return arguments.length?(n(t,e),o):t},o.scales=function(t){return arguments.length?(n(e,t),o):e},o.transition=function(t){return arguments.length?(r=t,o):r},o.update=function(t){return arguments.length?(l=t,o):l},o}t.ClusterMap=function(){const t={transitionDuration:250,scaleFactor:15,legend:{entryHeight:15,fontSize:14,onClickRect:null,onClickText:e,show:!0},colourBar:{fontSize:12,height:15,show:!0,width:150},scaleBar:{colour:"black",fontSize:12,height:15,basePair:2500,show:!0,stroke:1},cluster:{nameFontSize:12,lociFontSize:10,spacing:50},locus:{trackBar:{colour:"#111",stroke:1},spacing:50},gene:{shape:{bodyHeight:12,tipHeight:5,tipLength:12,onClick:function(t){let e=l.group.domain().filter(e=>{let n=l.group(e),a=l.group(t.uid);return null!=n&&n===a});if(0===e.length)return;let n=l.offset.domain(),a=l.offset.range(),r=t=>{let e=t.end-t.start;return l.x(t.start+e/2)+l.locus(t._locus)},o=r(t);for(const l of e){let e=d3.select("#gene_"+l).data()[0],s=n.findIndex(t=>t===e._cluster);if(l===t.uid){a[s]=0;continue}let i=r(e),c=Math.abs(o-i);i>o&&(c=-c),0!==c&&(a[s]=c)}l.offset.range(a),f()}},label:{anchor:"start",fontSize:10,rotation:25,show:!0,start:.5}}},l={x:d3.scaleLinear().domain([1,1001]),y:d3.scaleBand().padding(.05),offset:null,score:d3.scaleSequential(d3.interpolateGreys).domain([0,1]),group:d3.scaleOrdinal().unknown(null),colour:d3.scaleOrdinal().unknown("#bbb"),locus:d3.scaleOrdinal()};let o=d3.transition().duration(t.transitionDuration),s=null;function i(e){e.each((function(e){console.log("Start building",t),console.log("Updating scales"),function(e){l.offset||(l.offset=d3.scaleOrdinal().domain(e.clusters.map(t=>t.uid)).range(e.clusters.map(()=>0)));l.x.range([0,t.scaleFactor]),l.y.domain(e.clusters.map(t=>t.uid)).range([0,e.clusters.length*(2*t.gene.shape.tipHeight+t.gene.shape.bodyHeight)+(e.clusters.length-1)*t.cluster.spacing])}(e),console.log("Updating colour scales"),function(t){let e=function(t){let e=[];return t.forEach(t=>{let n=!1;for(let a=0;a<e.length;a++){let r=e[a];if((r.includes(t.query.uid)||r.includes(t.target.uid))&&(n=!0),n){r.includes(t.query.uid)||r.push(t.query.uid),r.includes(t.target.uid)||r.push(t.target.uid);break}}n||e.push([t.query.uid,t.target.uid])}),e}(t.links),n=e.map((t,e)=>e);l.colour.domain(n).range(d3.quantize(d3.interpolateRainbow,e.length+1));let{domain:a,range:r}=function(t){let e={domain:[],range:[]};return t.forEach((t,n)=>{e.domain.push(...t),e.range.push(...t.map(()=>n))}),e}(e);l.group.domain(a).range(r)}(e),console.log("Updating transition"),o=d3.transition().duration(t.transitionDuration),s=d3.select(this).attr("width","100%").attr("height","100%"),console.log("Building cluster map"),s.selectAll("svg.clusterMap").data([e]).join(t=>{t.append("input").attr("id","picker").attr("class","colourPicker").attr("type","color").style("opacity",0);let e=t.append("svg").attr("class","clusterMap").attr("id","root-svg").attr("cursor","grab").attr("width","100%").attr("height","100%").attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xhtml","http://www.w3.org/1999/xhtml"),n=e.append("g"),a=d3.zoom().scaleExtent([0,8]).on("zoom",()=>n.attr("transform",d3.event.transform)).on("start",()=>e.attr("cursor","grabbing")).on("end",()=>e.attr("cursor","grab")),r=d3.zoomIdentity.translate(20,50).scale(1.2);return e.call(a).call(a.transform,r),n.call(h)},t=>t.call(t=>t.transition(o).call(h))),console.log("Finished")}))}function c(){let e=prompt("Enter new length (bp):",t.scaleBar.basePair);e&&(t.scaleBar.basePair=e,f())}function u(){return function(t){let e=1e3,n=1,a=10,r="black",l=12,o=d3.transition().duration(500),s=null;function i(t){t.each((function(t){d3.select(this).selectAll("g.scaleBar").data([t]).join(t=>((t=t.append("g").attr("class","scaleBar")).append("line").attr("class","flatBar"),t.append("line").attr("class","leftBar"),t.append("line").attr("class","rightBar"),t.append("text").attr("class","barText").attr("text-anchor","middle").attr("cursor","pointer").on("click",s||d),t.call(u),t),t=>t.call(t=>t.transition(o).call(u)))}))}function c(){return+(e/1e3).toFixed(1)+"kb"}function u(o){let s=a/2,i=t(e);o.select(".flatBar").attr("x2",i).attr("y1",s).attr("y2",s),o.select(".leftBar").attr("y2",a),o.select(".rightBar").attr("x1",i).attr("x2",i).attr("y2",a),o.select("text.barText").text(c).attr("x",i/2).attr("y",a+20).style("font-size",l),o.selectAll("line").style("stroke",r).style("stroke-width",n)}function d(){let t=prompt("Enter new length (bp):",e);t&&i.basePair(t)}return i.basePair=function(t){return arguments.length?(e=parseInt(t),i):e},i.stroke=function(t){return arguments.length?(n=parseInt(t),i):n},i.height=function(t){return arguments.length?(a=parseInt(t),i):a},i.colour=function(t){return arguments.length?(r=t,i):r},i.fontSize=function(t){return arguments.length?(l=parseInt(t),i):l},i.onClickText=function(t){return arguments.length?(s=t,i):s},i.transition=function(t){return arguments.length?(o=t,i):o},i}(l.x).stroke(t.scaleBar.stroke).height(t.scaleBar.height).colour(t.scaleBar.colour).basePair(t.scaleBar.basePair).fontSize(t.scaleBar.fontSize).onClickText(c).transition(o)}function d(){return function(t,e){let n=25,a=150,r=12;function l(t){t.each((function(t){d3.select(this).selectAll("g.colourBar").data([t]).join(t=>{let e=(t=t.append("g").attr("class","colourBar")).append("defs").append("linearGradient").attr("id","cbarGradient").attr("x1","0%").attr("x2","100%");e.append("stop").attr("class","startStop").attr("offset","0%"),e.append("stop").attr("class","endStop").attr("offset","100%");let n=t.append("g").attr("class","cbarParts");return n.append("rect").attr("class","colourBarBG").style("fill","white").style("stroke","black").style("stroke-width","1px"),n.append("rect").attr("class","colourBarFill").style("fill","url(#cbarGradient)"),n.append("text").text("Identity (%)").attr("class","labelText").attr("text-anchor","middle"),n.append("text").text("0").attr("class","startText").attr("text-anchor","start"),n.append("text").text("100").attr("class","endText").attr("text-anchor","end"),n.selectAll("text").style("font-family","sans-serif"),t.call(o),t},t=>t.call(t=>t.transition(e).call(o)))}))}function o(e){e.select(".startStop").attr("stop-color",t(0)),e.select(".endStop").attr("stop-color",t(1)),e.selectAll("rect").attr("width",a).attr("height",n),e.selectAll(".startText, .endText, .labelText").attr("y",n+20),e.select(".labelText").attr("x",a/2),e.select(".endText").attr("x",a),e.selectAll("text").style("font-size",r)}return l.width=t=>arguments.length?(a=parseInt(t),l):a,l.height=t=>arguments.length?(n=parseInt(t),l):n,l.fontSize=t=>arguments.length?(r=parseInt(t),l):r,l.colourScale=e=>arguments.length?(t=e,l):t,l.transition=t=>arguments.length?(e=t,l):e,l}(l.score).width(t.colourBar.width).height(t.colourBar.height).fontSize(t.colourBar.fontSize).transition(o)}function g(){return function(){const t={transitionDuration:500,scaleFactor:15,nameFontSize:12,lociFontSize:10,spacing:60,locus:{trackBar:{colour:"#111",stroke:1},spacing:50},gene:{shape:{bodyHeight:12,tipHeight:5,tipLength:12,onClick:null},label:{anchor:"start",fontSize:10,rotation:12,show:!0,start:.5}}};let l=[];const o={x:d3.scaleLinear().domain([0,1e3]).range([0,t.scaleFactor]),y:null,group:null,colour:null,offset:d3.scaleOrdinal(),locus:d3.scaleOrdinal()};let s=d3.transition().duration(t.transitionDuration),i=null,c=()=>{i&&i.call(u)};function u(n){n.each((function(n){h(n),o.y||(o.y=d3.scaleBand().padding(.05).domain(n.clusters.map(t=>t.uid)).range([0,n.clusters.length*(2*t.gene.shape.tipHeight+t.gene.shape.bodyHeight)+(n.clusters.length-1)*t.spacing])),i=d3.select(this);let l=i.selectAll("g.links").data([n]).join("g").attr("class","links"),u=i.selectAll("g.clusters").data([n.clusters]).join("g").attr("class","clusters").selectAll("g.cluster").data(n.clusters,t=>t.uid).join(n=>{let a=(n=n.append("g").attr("id",d).attr("class","cluster")).append("g").attr("id",t=>"cinfo_"+t.uid).attr("class","clusterInfo").attr("transform","translate(-10, 0)");return a.append("text").text(t=>t.name).attr("class","clusterText").attr("y",8).attr("cursor","pointer").style("font-weight","bold").on("click",t.onClickText||e),a.append("text").attr("class","locusText").attr("y",22),a.selectAll("text").attr("text-anchor","end").style("font-family","sans"),n.call(f),n},t=>t.call(t=>t.transition(s).call(f))),g=a().config({trackBar:t.locus.trackBar,spacing:t.locus.spacing,gene:t.gene}).scales(o).transition(s).update(c);u.call(g);let p=r().config(t).scales(o).transition(s).update(c);l.call(p)}))}function d(t){return"cluster_"+t.uid}function g(e){let n,a,r=[],l=1;for(const s of e.loci)n&&(l=r[r.length-1]+a-n+t.locus.spacing),n=o.x(s._start||s.start),a=o.x(s._end||s.end),r.push(l-n);return r}function p(t){let e=[],n=[];return t.forEach(t=>{let a=t.loci.map(t=>t.uid),r=g(t);e.push(...a),n.push(...r)}),[e,n]}function h(t){let[e,n]=p(t.clusters);o.locus.domain(e).range(n)}function f(e){e.attr("transform",t=>`translate(${o.offset(t.uid)}, ${o.y(t.uid)})`),e.select(".clusterInfo").attr("transform","translate(-10, 0)"),e.selectAll("text.clusterText").style("font-size",t.nameFontSize+"px"),e.selectAll("text.locusText").text(x).style("font-size",t.lociFontSize+"px")}function x(t){return t.loci.map(t=>t._start&&t._end?`${t.name}:${t._start.toFixed(0)}-${t._end.toFixed(0)}`:t.name).join(", ")}return u.anchors=t=>arguments.length?(l=t,u):l,u.config=function(e){return arguments.length?(n(t,e),u):t},u.scales=function(t){return arguments.length?(n(o,t),u):o},u.transition=function(t){return arguments.length?(s=t,u):s},u.update=function(t){return arguments.length?(c=t,u):c},u}().config({...t.cluster,locus:t.locus,gene:t.gene}).scales(l).update(f).transition(o)}function p(){return function(t){let n=15,a=12,r=null,l=e,o=d3.scaleBand().paddingInner(.5),s=d3.transition().duration(500);function i(e){e.each((function(e){let i=t.domain();o.domain(i).range([0,n*i.length]);let c=d3.select(this).selectAll("g.legend").data([e]).join("g").attr("class","legend"),u=t=>`translate(0, ${o(t)})`;c.selectAll("g.element").data(i).join(e=>((e=e.append("g").attr("class","element").attr("transform",u)).append("rect").attr("fill",e=>t(e)).attr("class",t=>"group-"+t).attr("width",12).attr("height",o.bandwidth()),e.append("text").text(t=>"Group "+t).attr("x",16).attr("y",o.bandwidth()).attr("text-anchor","start").style("font-family","sans").style("font-size",a),e),t=>t.call(t=>t.transition(s).attr("transform",u))),r&&c.selectAll("rect").attr("cursor","pointer").on("click",r),l&&c.selectAll("text").attr("cursor","pointer").on("click",l)}))}return i.colourScale=function(e){return arguments.length?(t=e,i):t},i.transition=function(t){return arguments.length?(s=t,s):s},i.entryHeight=function(t){return arguments.length?(n=parseInt(t),i):n},i.fontSize=function(t){return arguments.length?(a=parseInt(t),i):a},i.onClickRect=function(t){return arguments.length?(r=t,i):r},i.onClickText=function(t){return arguments.length?(l=t,i):l},i}(l.colour).fontSize(t.legend.fontSize).entryHeight(t.legend.entryHeight).onClickRect(t.legend.onClickRect).onClickText(t.legend.onClickText)}function h(t){let e=g(),n=p(),a=u(),r=d();return t.call(e).call(n).call(r).call(a).call(x)}function f(){s.transition(o).call(i)}function x(e){e.select("g.scaleBar").attr("transform",`translate(0, ${l.y.range()[1]})`),e.select("g.colourBar").attr("transform",`translate(${l.x(t.scaleBar.basePair)+20}, ${l.y.range()[1]})`),e.select("g.legend").attr("transform",t=>{let e=function(t){let e=0;for(let n of t){let t=n.loci.reduce((t,e)=>t+(e._end-e._start),0);t>e&&(e=t)}return e}(t.clusters);return`translate(${l.x(e)+20}, 0)`})}return i.config=function(e){return arguments.length?(t=n(e,t),i):t},i},Object.defineProperty(t,"__esModule",{value:!0})}));
